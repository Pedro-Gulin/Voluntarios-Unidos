{% extends"base.html" %}
{% block content%}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relatório: Horas por voluntario por mes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#f8f9fa; font-family: Arial, sans-serif; padding:2rem; }
    .container { max-width:900px; margin:auto; background:#fff; padding:2rem; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
  </style>
</head>
<body>
  <div class="container">
    <h3 class="mb-3">Relatório da quantidade de horas trabalhadas por voluntario por mes</h3>
    <div class="input-group mb-4" style="max-width:400px;">
      <input type="month" id="mes" class="form-control">
      <button class="btn btn-primary" id="buscar">Buscar</button>
    </div>
    <canvas id="grafico"></canvas>
  </div>

  <script>
    const mesInput = document.getElementById('mes');
    const ctx = document.getElementById('grafico').getContext('2d');
    let grafico;

    const formatarMesAno = mes => mes ? `${mes.split('-')[1]}/${mes.split('-')[0]}` : '';

    async function carregarGrafico(mes) {
      try {
        const resp = await fetch(`/api/horas_volu_mes?mes=${mes}`);
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || "Erro ao buscar dados");
        }
        const data = await resp.json();

        if (grafico) grafico.destroy();
        grafico = new Chart(ctx, {
          type: 'bar',
          data,
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: data.labels.length ?
                      `Horas trabalhadas em ${formatarMesAno(mes)}` :
                      `Sem dados para ${formatarMesAno(mes)}`
              },
              legend: { display: false }
            },
            scales: {
              y: { beginAtZero: true, title: { display: true, text: 'Horas' } },
              x: { title: { display: true, text: 'Voluntario' } }
            }
          }
        });
      } catch (err) {
        console.error(err);
        alert("Erro ao carregar gráfico. Verifique o console para mais detalhes.");
      }
    }

    document.getElementById('buscar').onclick = () => {
      if (!mesInput.value) return alert("Selecione um mês primeiro!");
      carregarGrafico(mesInput.value);
    };

    const hoje = new Date();
    const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2, '0')}`;
    mesInput.value = mesAtual;
    carregarGrafico(mesAtual);
  </script>
</body>
{% endblock%}